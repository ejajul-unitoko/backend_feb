<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Address System Test Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            max-width: 1400px;
            margin: auto;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }

        .section {
            background: white;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            margin-top: 0;
            color: #007bff;
            font-size: 18px;
        }

        .utb-section {
            border-left: 4px solid #28a745;
        }

        .auth-section {
            border-left: 4px solid #ffc107;
        }

        input,
        select,
        textarea {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        textarea {
            width: calc(100% - 20px);
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            margin: 5px 5px 5px 0;
        }

        button:hover {
            background: #0056b3;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        button.warning {
            background: #ffc107;
            color: #333;
        }

        button.warning:hover {
            background: #e0a800;
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            overflow-x: auto;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            max-height: 400px;
        }

        .response {
            margin-top: 10px;
        }

        .success-response {
            border-left: 4px solid #28a745;
        }

        .error-response {
            border-left: 4px solid #dc3545;
        }

        .token-display {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
            color: #555;
        }

        .info-box {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }

        .edge-case-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
    </style>
</head>

<body>
    <h1>üìç Address System - Test Dashboard</h1>
    <p>Dedicated testing for Address Management via Business and Branch flows.</p>

    <!-- Authentication Section -->
    <div class="section auth-section">
        <h2>üîê Authentication</h2>
        <div class="info-box">
            <strong>Setup:</strong> Use OTP-based registration/login or password login. System uses
            <code>x-app-type</code> header for scope.
        </div>

        <h3>Step 1: Register / Login with OTP</h3>
        <label>Email:</label>
        <input type="email" id="email" placeholder="Email" value="business@test.com">

        <label>Scope:</label>
        <select id="scope">
            <option value="utb">UTB (Business)</option>
            <option value="uta">UTA (Admin)</option>
        </select>

        <button onclick="sendOtp()">Send OTP</button>
        <button class="warning" onclick="showPasswordLogin()">Login with Password</button>

        <div id="otpSection" style="display:none; margin-top: 15px;">
            <h3>Step 2: Verify OTP</h3>
            <label>OTP Code (check console):</label>
            <input type="text" id="otp" placeholder="Enter OTP">
            <button onclick="verifyOtp()">Verify & Login</button>
        </div>

        <div id="profileSection"
            style="display:none; margin-top: 15px; background: #fff3cd; padding: 15px; border-radius: 4px; border: 1px solid #ffc107;">
            <h3>‚ö†Ô∏è Complete Your Profile</h3>
            <div class="info-box">
                <strong>Profile Incomplete:</strong> Please provide your details to continue.
            </div>

            <label>Full Name:</label>
            <input type="text" id="profileName" placeholder="Your Full Name">

            <label>Phone:</label>
            <input type="text" id="profilePhone" placeholder="Your Phone Number">

            <label>Set Password (optional, for future logins):</label>
            <input type="password" id="profilePassword" placeholder="Create a password">

            <button class="success" onclick="completeProfile()">Save Profile & Continue</button>
        </div>

        <div id="passwordSection"
            style="display:none; margin-top: 15px; background: #f8f9fa; padding: 15px; border-radius: 4px;">
            <h3>üîë Login with Password</h3>
            <label>Email:</label>
            <input type="email" id="loginEmail" placeholder="Email" value="business@test.com">

            <label>Password:</label>
            <input type="password" id="loginPassword" placeholder="Password" value="password123">

            <label>Scope:</label>
            <select id="loginScope">
                <option value="utb">UTB (Business)</option>
                <option value="uta">UTA (Admin)</option>
            </select>

            <button onclick="loginWithPassword()">Login</button>
            <button onclick="hidePasswordLogin()">Cancel</button>
        </div>

        <div id="tokenDisplay" class="token-display" style="display:none;">
            <strong>JWT Token:</strong> <span id="tokenValue"></span>
        </div>

        <div id="authResponse" class="response"></div>
    </div>


    <!-- UTB: Business Management with Address Focus -->
    <div class="section utb-section">
        <h2>Fn 1: Address via Business Registration</h2>
        <div class="info-box">
            Registers a business and validates the <strong>Structured Address</strong> format.
        </div>

        <label>Legal Name:</label>
        <input type="text" id="legalName" value="Address Test Biz Pvt Ltd">

        <label>Display Name:</label>
        <input type="text" id="displayName" value="Address Test Biz">

        <label>Business Type:</label>
        <select id="businessType">
            <option value="private_limited">Private Limited</option>
            <option value="proprietorship">Proprietorship</option>
        </select>

        <label>PAN (10 chars):</label>
        <input type="text" id="pan" value="ABCDE1234F" maxlength="10">

        <h3>Registered Address</h3>
        <label>Address Line 1:</label>
        <input type="text" id="regAddrLine1" value="123 Register St">

        <label>Address Line 2 (optional):</label>
        <input type="text" id="regAddrLine2" placeholder="Suite/Unit">

        <div class="grid">
            <div>
                <label>City:</label>
                <input type="text" id="regCity" value="Mumbai">
            </div>
            <div>
                <label>Pincode:</label>
                <input type="text" id="regPincode" value="400001" maxlength="6">
            </div>
        </div>

        <div class="grid">
            <div>
                <label>State:</label>
                <input type="text" id="regState" value="Maharashtra">
            </div>
            <div>
                <label>Country:</label>
                <input type="text" id="regCountry" value="India">
            </div>
        </div>

        <button onclick="registerBusiness()">Register Business & Address</button>
        <div id="registerBusinessResponse" class="response"></div>

        <h3>Get Business Details (Verify Address)</h3>
        <label>Business ID:</label>
        <input type="text" id="updateBusinessId" placeholder="Business UUID">
        <button onclick="getMyBusiness()">Get My Business</button>
        <div id="getBusinessResponse" class="response"></div>
    </div>

    <!-- UTB: Branch Management -->
    <div class="section utb-section">
        <h2>Fn 2: Address via Branch Creation</h2>
        <div class="info-box">
            Creates a branch and links it to a new <strong>Address Entry</strong>.
        </div>

        <label>Business ID (from above):</label>
        <input type="text" id="branchBusinessId" placeholder="Business UUID">

        <label>Branch Name:</label>
        <input type="text" id="branchName" value="South Branch">

        <h3>Branch Address</h3>
        <label>Address Line 1:</label>
        <input type="text" id="branchAddrLine1" value="456 Branch Ave">

        <div class="grid">
            <div>
                <label>City:</label>
                <input type="text" id="branchCity" value="Bangalore">
            </div>
            <div>
                <label>Pincode:</label>
                <input type="text" id="branchPincode" value="560001" maxlength="6">
            </div>
        </div>

        <label>Latitude (optional):</label>
        <input type="text" id="branchLat" placeholder="12.9716">

        <label>Longitude (optional):</label>
        <input type="text" id="branchLon" placeholder="77.5946">

        <button onclick="createBranch()">Create Branch & Address</button>
        <div id="createBranchResponse" class="response"></div>

        <h3>Get My Branches (Check Address Link)</h3>
        <button onclick="getMyBranches()">Get My Branches</button>
        <div id="getBranchesResponse" class="response"></div>
        <!-- UTA: Admin Address Management -->
        <div class="section" style="border-left: 4px solid #007bff;">
            <h2>Fn 3: Admin Address Management (UTA)</h2>
            <div class="info-box">
                Manage all addresses in the system. Requires <strong>UTA</strong> scope.
            </div>

            <h3>List All Addresses</h3>
            <div class="grid">
                <div>
                    <label>Type Filter (optional):</label>
                    <select id="adminAddrType">
                        <option value="">All</option>
                        <option value="business_registered">Business Registered</option>
                        <option value="branch">Branch</option>
                        <option value="customer_home">Customer Home</option>
                        <option value="customer_work">Customer Work</option>
                        <option value="customer_other">Customer Other</option>
                    </select>
                </div>
                <div>
                    <label>City Filter (optional):</label>
                    <input type="text" id="adminAddrCity" placeholder="e.g. Mumbai">
                </div>
            </div>
            <button class="warning" onclick="getAllAddresses()">List All Addresses</button>
            <div id="getAllAddressesResponse" class="response"></div>

            <h3>Create New Address</h3>
            <label>User ID (optional, defaults to you):</label>
            <input type="text" id="adminNewAddrUserId" placeholder="User UUID">

            <label>Line 1:</label>
            <input type="text" id="adminNewAddrLine1" value="Administrative Building, Block A">

            <div class="grid">
                <div>
                    <label>City:</label>
                    <input type="text" id="adminNewAddrCity" value="New Delhi">
                </div>
                <div>
                    <label>Pincode:</label>
                    <input type="text" id="adminNewAddrPincode" value="110001">
                </div>
            </div>

            <label>Type:</label>
            <select id="adminNewAddrType">
                <option value="business_registered">Business Registered</option>
                <option value="branch_location">Branch Location</option>
                <option value="customer_home">Customer Home</option>
                <option value="customer_work">Customer Work</option>
                <option value="other">Other</option>
            </select>

            <button class="success" onclick="createAdminAddress()">Create Address</button>
            <div id="createAdminAddressResponse" class="response"></div>

            <h3>Manage Single Address</h3>
            <label>Address ID:</label>
            <input type="text" id="adminAddrId" placeholder="Address UUID">

            <button onclick="getAddressById()">Get Details</button>
            <button class="danger" onclick="deleteAddress()">Delete Address</button>
            <div id="singleAddressResponse" class="response"></div>
        </div>

        <script>
            // NOTE: Port is 4000
            const API_BASE = 'http://localhost:4000/api';
            let authToken = '';
            let authScope = 'utb';

            // Helper function to display response
            function displayResponse(elementId, data, isError = false) {
                const element = document.getElementById(elementId);
                element.innerHTML = `<pre class="${isError ? 'error-response' : 'success-response'}">${JSON.stringify(data, null, 2)}</pre>`;

                // Auto-fill IDs if successful registration
                if (elementId === 'registerBusinessResponse' && !isError && data.data) {
                    if (data.data.id) {
                        document.getElementById('branchBusinessId').value = data.data.id;
                        document.getElementById('updateBusinessId').value = data.data.id;
                    }
                }
            }

            // Helper function to make API calls
            async function apiCall(endpoint, method = 'GET', body = null, useAuth = true) {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (useAuth && authToken) {
                    options.headers['Authorization'] = `Bearer ${authToken}`;
                    options.headers['x-app-type'] = authScope;
                }

                if (body) {
                    options.body = JSON.stringify(body);
                }

                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, options);
                    const data = await response.json();
                    return { data, status: response.status, isError: !response.ok };
                } catch (error) {
                    return { data: { error: error.message }, status: 0, isError: true };
                }
            }

            // Authentication Functions
            async function sendOtp() {
                const email = document.getElementById('email').value;
                const scope = document.getElementById('scope').value;

                try {
                    const response = await fetch(`${API_BASE}/auth/otp/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-app-type': scope
                        },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();
                    displayResponse('authResponse', data, !response.ok);

                    if (response.ok) {
                        document.getElementById('otpSection').style.display = 'block';
                    }
                } catch (error) {
                    displayResponse('authResponse', { error: error.message }, true);
                }
            }

            async function verifyOtp() {
                const email = document.getElementById('email').value;
                const otp = document.getElementById('otp').value;
                const scope = document.getElementById('scope').value;

                try {
                    const response = await fetch(`${API_BASE}/auth/otp/verify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-app-type': scope
                        },
                        body: JSON.stringify({ email, otp })
                    });

                    const data = await response.json();
                    displayResponse('authResponse', data, !response.ok);

                    if (response.ok && data.accessToken) {
                        authToken = data.accessToken;
                        authScope = scope; // Update scope based on login

                        // Check if profile is complete
                        if (data.is_profile_complete === false) {
                            // Show profile completion form
                            document.getElementById('otpSection').style.display = 'none';
                            document.getElementById('profileSection').style.display = 'block';
                        } else {
                            // Profile complete, show token
                            document.getElementById('tokenDisplay').style.display = 'block';
                            document.getElementById('tokenValue').textContent = authToken;
                            document.getElementById('otpSection').style.display = 'none';
                        }
                    }
                } catch (error) {
                    displayResponse('authResponse', { error: error.message }, true);
                }
            }

            async function completeProfile() {
                const name = document.getElementById('profileName').value;
                const phone = document.getElementById('profilePhone').value;
                const password = document.getElementById('profilePassword').value;
                const scope = document.getElementById('scope').value;

                if (!name || !phone) {
                    alert('Please provide both name and phone number');
                    return;
                }

                try {
                    // Update profile
                    const profileResponse = await fetch(`${API_BASE}/auth/profile`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`,
                            'x-app-type': scope
                        },
                        body: JSON.stringify({ name, phone })
                    });

                    const profileData = await profileResponse.json();
                    displayResponse('authResponse', profileData, !profileResponse.ok);

                    // If password provided, set it
                    if (password && profileResponse.ok) {
                        const passwordResponse = await fetch(`${API_BASE}/auth/password/set`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`,
                                'x-app-type': scope
                            },
                            body: JSON.stringify({ password })
                        });

                        const passwordData = await passwordResponse.json();
                        console.log('Password set:', passwordData);
                    }

                    if (profileResponse.ok) {
                        // Hide profile section, show token
                        document.getElementById('profileSection').style.display = 'none';
                        document.getElementById('tokenDisplay').style.display = 'block';
                        document.getElementById('tokenValue').textContent = authToken;

                        displayResponse('authResponse', {
                            success: true,
                            message: 'Profile completed successfully!',
                            user: profileData.user
                        }, false);
                    }
                } catch (error) {
                    displayResponse('authResponse', { error: error.message }, true);
                }
            }

            function showPasswordLogin() {
                document.getElementById('passwordSection').style.display = 'block';
            }

            function hidePasswordLogin() {
                document.getElementById('passwordSection').style.display = 'none';
            }

            async function loginWithPassword() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const scope = document.getElementById('loginScope').value;

                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-app-type': scope
                        },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();
                    displayResponse('authResponse', data, !response.ok);

                    if (response.ok && data.accessToken) {
                        authToken = data.accessToken;
                        authScope = scope; // Update scope based on login
                        document.getElementById('tokenDisplay').style.display = 'block';
                        document.getElementById('tokenValue').textContent = authToken;
                        document.getElementById('passwordSection').style.display = 'none';
                    }
                } catch (error) {
                    displayResponse('authResponse', { error: error.message }, true);
                }
            }


            // UTB: Business Management
            async function getMyBusiness() {
                const result = await apiCall('/utb/business');
                displayResponse('getBusinessResponse', result.data, result.isError);
            }

            async function registerBusiness() {
                const result = await apiCall('/utb/business', 'POST', {
                    legal_name: document.getElementById('legalName').value,
                    display_name: document.getElementById('displayName').value,
                    business_type: document.getElementById('businessType').value,
                    pan: document.getElementById('pan').value,
                    gstin: null,
                    registered_address: {
                        address_line_1: document.getElementById('regAddrLine1').value,
                        address_line_2: document.getElementById('regAddrLine2').value,
                        city: document.getElementById('regCity').value,
                        state: document.getElementById('regState').value,
                        country: document.getElementById('regCountry').value,
                        pincode: document.getElementById('regPincode').value
                    }
                });

                displayResponse('registerBusinessResponse', result.data, result.isError);
            }

            // UTB: Branch Management
            async function getMyBranches() {
                const result = await apiCall('/utb/branches');
                displayResponse('getBranchesResponse', result.data, result.isError);
            }

            async function createBranch() {
                const lat = document.getElementById('branchLat').value;
                const lon = document.getElementById('branchLon').value;
                const businessId = document.getElementById('branchBusinessId').value;

                if (!businessId) {
                    alert('Please Register a Business first to get a Business ID');
                    return;
                }

                const result = await apiCall('/utb/branches', 'POST', {
                    business_id: businessId,
                    name: document.getElementById('branchName').value,
                    address: {
                        address_line_1: document.getElementById('branchAddrLine1').value,
                        city: document.getElementById('branchCity').value,
                        state: 'Delhi', // Defaulting for simplicity in UI, can add field if needed
                        country: 'India',
                        pincode: document.getElementById('branchPincode').value
                    },
                    latitude: lat ? parseFloat(lat) : null,
                    longitude: lon ? parseFloat(lon) : null
                });

                displayResponse('createBranchResponse', result.data, result.isError);
            }

            // UTA: Admin Address Management
            async function getAllAddresses() {
                const type = document.getElementById('adminAddrType').value;
                const city = document.getElementById('adminAddrCity').value;

                let query = [];
                if (type) query.push(`type=${type}`);
                if (city) query.push(`city=${encodeURIComponent(city)}`);

                const queryString = query.length > 0 ? `?${query.join('&')}` : '';

                // Scope must be 'uta' for this
                // const originalScope = authScope;
                // authScope = 'uta'; // Temporarily switch or ensure user is logged in as admin

                const result = await apiCall(`/admin/addresses${queryString}`);
                displayResponse('getAllAddressesResponse', result.data, result.isError);
            }

            async function createAdminAddress() {
                const userId = document.getElementById('adminNewAddrUserId').value;
                const type = document.getElementById('adminNewAddrType').value;

                // Map frontend type to valid DB purpose
                let purpose = 'customer_delivery'; // Default
                if (type === 'business_registered') purpose = 'business_registered';
                if (type === 'branch_location') purpose = 'branch_location';

                const result = await apiCall('/admin/addresses', 'POST', {
                    user_id: userId || null,
                    address_line_1: document.getElementById('adminNewAddrLine1').value,
                    city: document.getElementById('adminNewAddrCity').value,
                    state: 'Delhi',
                    country: 'India',
                    pincode: document.getElementById('adminNewAddrPincode').value,
                    type: type,
                    purpose: purpose
                });
                displayResponse('createAdminAddressResponse', result.data, result.isError);
            }

            async function getAddressById() {
                const id = document.getElementById('adminAddrId').value;
                if (!id) {
                    alert('Please enter an Address ID');
                    return;
                }
                const result = await apiCall(`/admin/addresses/${id}`);
                displayResponse('singleAddressResponse', result.data, result.isError);
            }

            async function deleteAddress() {
                const id = document.getElementById('adminAddrId').value;
                if (!id) {
                    alert('Please enter an Address ID');
                    return;
                }
                if (!confirm('Are you sure you want to delete this address?')) return;

                const result = await apiCall(`/admin/addresses/${id}`, 'DELETE');
                displayResponse('singleAddressResponse', result.data, result.isError);
            }
        </script>
</body>

</html>