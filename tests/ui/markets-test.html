<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markets System - Test Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: auto;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }

        .section {
            background: white;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            margin-top: 0;
            color: #007bff;
            font-size: 18px;
        }

        .public-section {
            border-left: 4px solid #28a745;
        }

        .admin-section {
            border-left: 4px solid #dc3545;
        }

        input,
        select,
        textarea {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        textarea {
            width: calc(100% - 20px);
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            margin: 5px 5px 5px 0;
        }

        button:hover {
            background: #0056b3;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            overflow-x: auto;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            max-height: 400px;
            overflow-y: auto;
        }

        .market-card {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .market-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }

        .badge-active {
            background: #28a745;
            color: white;
        }

        .badge-inactive {
            background: #6c757d;
            color: white;
        }

        .badge-public {
            background: #17a2b8;
            color: white;
        }

        .badge-private {
            background: #ffc107;
            color: #333;
        }

        .login-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <h1>üè™ Markets System - Test Dashboard</h1>
    <p>Test all market endpoints for both public (UTC/UTB) and admin (UTA) access</p>

    <!-- PUBLIC ENDPOINTS -->
    <div class="section public-section">
        <h2>üåç PUBLIC ENDPOINTS (No Authentication Required)</h2>
        <p><em>These endpoints are accessible to everyone, including non-logged-in users (UTC)</em></p>

        <div class="grid">
            <div>
                <h3>üìã List All Public Markets</h3>
                <label>Filter by City:</label>
                <input type="text" id="publicCity" placeholder="Delhi" value="Delhi">
                <br>
                <button class="success" onclick="getPublicMarkets()">Get Public Markets</button>
            </div>

            <div>
                <h3>üîç Search Markets</h3>
                <label>Search Query:</label>
                <input type="text" id="searchQuery" placeholder="e.g., chandni, karol">
                <br>
                <button class="success" onclick="searchMarkets()">Search Markets</button>
            </div>
        </div>

        <div id="publicMarketsResult"></div>
    </div>

    <!-- ADMIN LOGIN -->
    <div class="section admin-section">
        <h2>üîê ADMIN LOGIN (Required for Admin Operations)</h2>

        <div class="login-box">
            <strong>‚ö†Ô∏è Login Required</strong>
            <p>To test admin endpoints, you must login first. Use your admin credentials.</p>
        </div>

        <div class="grid">
            <div>
                <label>Email:</label>
                <input type="email" id="loginEmail" placeholder="ejajul@unitoko.com" value="ejajul@unitoko.com">
                <label>Password:</label>
                <input type="password" id="loginPassword" placeholder="Password" value="password123">
                <button onclick="loginAdmin()">Login as Admin</button>
            </div>
            <div id="loginStatus" style="padding: 10px;">
                <strong>Status:</strong> Not logged in
            </div>
        </div>
    </div>

    <!-- ADMIN ENDPOINTS -->
    <div class="section admin-section">
        <h2>üõ†Ô∏è ADMIN ENDPOINTS (Authentication Required)</h2>
        <p><em>These endpoints require admin authentication and proper RBAC permissions</em></p>

        <div class="grid">
            <div>
                <h3>‚ûï Create Market</h3>
                <label>Market Name:</label>
                <input type="text" id="createName" placeholder="Chandni Chowk">
                <label>Description:</label>
                <textarea id="createDesc" placeholder="Famous market in Old Delhi" rows="3"></textarea>
                <label>Latitude (optional):</label>
                <input type="text" id="createLat" placeholder="28.6506">
                <label>Longitude (optional):</label>
                <input type="text" id="createLng" placeholder="77.2303">
                <button class="success" onclick="createMarket()">Create Market</button>
            </div>

            <div>
                <h3>üìä Get All Markets (Admin View)</h3>
                <label>Filter by Status:</label>
                <select id="adminStatus">
                    <option value="">All</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
                <br><br>
                <button onclick="getAllMarketsAdmin()">Get All Markets</button>
            </div>
        </div>

        <div class="grid">
            <div>
                <h3>‚úèÔ∏è Update Market</h3>
                <label>Market ID:</label>
                <input type="text" id="updateId" placeholder="UUID from market list">
                <label>New Name:</label>
                <input type="text" id="updateName" placeholder="Updated name">
                <label>New Description:</label>
                <textarea id="updateDesc" placeholder="Updated description" rows="2"></textarea>
                <button onclick="updateMarket()">Update Market</button>
            </div>

            <div>
                <h3>üîÑ Toggle Market Status</h3>
                <label>Market ID:</label>
                <input type="text" id="toggleId" placeholder="UUID from market list">
                <br><br>
                <button onclick="toggleMarketStatus()">Toggle Status (Active ‚Üî Inactive)</button>
            </div>
        </div>

        <div>
            <h3>üóëÔ∏è Delete Market</h3>
            <label>Market ID:</label>
            <input type="text" id="deleteId" placeholder="UUID from market list">
            <button class="danger" onclick="deleteMarket()">Delete Market</button>
        </div>

        <div id="adminMarketsResult"></div>
    </div>

    <!-- EDGE CASES TESTING -->
    <div class="section">
        <h2>üß™ Edge Cases Testing</h2>
        <div class="grid">
            <button onclick="testDuplicateMarket()">Test: Duplicate Market Name</button>
            <button onclick="testInactiveMarketVisibility()">Test: Inactive Market Visibility</button>
            <button onclick="testInvalidCoordinates()">Test: Invalid Coordinates</button>
            <button onclick="testEmptyMarketName()">Test: Empty Market Name</button>
        </div>
    </div>

    <!-- DEBUG LOG -->
    <div class="section">
        <h2>üìù Debug Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <pre id="log">Logs will appear here...</pre>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000/api';
        const API_PUBLIC = `${API_BASE}/public`;
        const API_ADMIN = `${API_BASE}/admin/markets`;
        const API_AUTH = `${API_BASE}/auth`;

        let ACCESS_TOKEN = null;

        function log(title, data) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `\n[${timestamp}] ${title}\n${JSON.stringify(data, null, 2)}\n${'='.repeat(80)}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = 'Logs cleared...';
        }

        // ==================== PUBLIC ENDPOINTS ====================

        async function getPublicMarkets() {
            const city = document.getElementById('publicCity').value;
            const url = city ? `${API_PUBLIC}/markets?city=${city}` : `${API_PUBLIC}/markets`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                log('GET Public Markets', data);

                if (data.success && data.data) {
                    displayMarkets(data.data, 'publicMarketsResult');
                }
            } catch (err) {
                log('ERROR: Get Public Markets', err.message);
            }
        }

        async function searchMarkets() {
            const query = document.getElementById('searchQuery').value;

            if (!query) {
                alert('Please enter a search query');
                return;
            }

            try {
                const res = await fetch(`${API_PUBLIC}/markets/search?q=${query}`);
                const data = await res.json();
                log('Search Markets', data);

                if (data.success && data.data) {
                    displayMarkets(data.data, 'publicMarketsResult');
                }
            } catch (err) {
                log('ERROR: Search Markets', err.message);
            }
        }

        // ==================== ADMIN AUTH ====================

        async function loginAdmin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const res = await fetch(`${API_AUTH}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-app-type': 'uta'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();
                log('Admin Login', data);

                if (res.ok && data.accessToken) {
                    ACCESS_TOKEN = data.accessToken;
                    document.getElementById('loginStatus').innerHTML = `
                        <strong>Status:</strong> ‚úÖ Logged in as ${data.user.email}<br>
                        <strong>Roles:</strong> ${data.roles?.map(r => r.name || r).join(', ') || 'N/A'}
                    `;
                    document.getElementById('loginStatus').style.background = '#d4edda';
                    document.getElementById('loginStatus').style.border = '1px solid #c3e6cb';
                } else {
                    alert('Login failed: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                log('ERROR: Login', err.message);
                alert('Login error: ' + err.message);
            }
        }

        // ==================== ADMIN ENDPOINTS ====================

        async function createMarket() {
            if (!ACCESS_TOKEN) {
                alert('Please login first!');
                return;
            }

            const name = document.getElementById('createName').value;
            const description = document.getElementById('createDesc').value;
            const latitude = document.getElementById('createLat').value;
            const longitude = document.getElementById('createLng').value;

            const body = { name, description };
            if (latitude) body.latitude = parseFloat(latitude);
            if (longitude) body.longitude = parseFloat(longitude);

            try {
                const res = await fetch(API_ADMIN, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'x-app-type': 'uta'
                    },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                log('Create Market', data);

                if (data.success) {
                    alert('Market created successfully!');
                    // Clear form
                    document.getElementById('createName').value = '';
                    document.getElementById('createDesc').value = '';
                    document.getElementById('createLat').value = '';
                    document.getElementById('createLng').value = '';
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                log('ERROR: Create Market', err.message);
                alert('Error: ' + err.message);
            }
        }

        async function getAllMarketsAdmin() {
            if (!ACCESS_TOKEN) {
                alert('Please login first!');
                return;
            }

            const status = document.getElementById('adminStatus').value;
            const url = status ? `${API_ADMIN}?status=${status}` : API_ADMIN;

            try {
                const res = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'x-app-type': 'uta'
                    }
                });

                const data = await res.json();
                log('Get All Markets (Admin)', data);

                if (data.success && data.data) {
                    displayMarkets(data.data, 'adminMarketsResult', true);
                }
            } catch (err) {
                log('ERROR: Get All Markets', err.message);
            }
        }

        async function updateMarket() {
            if (!ACCESS_TOKEN) {
                alert('Please login first!');
                return;
            }

            const id = document.getElementById('updateId').value;
            const name = document.getElementById('updateName').value;
            const description = document.getElementById('updateDesc').value;

            if (!id) {
                alert('Please enter a market ID');
                return;
            }

            const body = {};
            if (name) body.name = name;
            if (description) body.description = description;

            try {
                const res = await fetch(`${API_ADMIN}/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'x-app-type': 'uta'
                    },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                log('Update Market', data);

                if (data.success) {
                    alert('Market updated successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                log('ERROR: Update Market', err.message);
            }
        }

        async function toggleMarketStatus() {
            if (!ACCESS_TOKEN) {
                alert('Please login first!');
                return;
            }

            const id = document.getElementById('toggleId').value;

            if (!id) {
                alert('Please enter a market ID');
                return;
            }

            try {
                const res = await fetch(`${API_ADMIN}/${id}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'x-app-type': 'uta'
                    }
                });

                const data = await res.json();
                log('Toggle Market Status', data);

                if (data.success) {
                    alert(data.message);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                log('ERROR: Toggle Status', err.message);
            }
        }

        async function deleteMarket() {
            if (!ACCESS_TOKEN) {
                alert('Please login first!');
                return;
            }

            const id = document.getElementById('deleteId').value;

            if (!id) {
                alert('Please enter a market ID');
                return;
            }

            if (!confirm('Are you sure you want to delete this market?')) {
                return;
            }

            try {
                const res = await fetch(`${API_ADMIN}/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'x-app-type': 'uta'
                    }
                });

                const data = await res.json();
                log('Delete Market', data);

                if (data.success) {
                    alert('Market deleted successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                log('ERROR: Delete Market', err.message);
            }
        }

        // ==================== EDGE CASES ====================

        async function testDuplicateMarket() {
            if (!ACCESS_TOKEN) {
                alert('Please login first!');
                return;
            }

            log('EDGE CASE TEST', 'Testing duplicate market name...');

            // Create first market
            await fetch(API_ADMIN, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ACCESS_TOKEN}`,
                    'x-app-type': 'uta'
                },
                body: JSON.stringify({ name: 'Test Duplicate Market', description: 'First instance' })
            });

            // Try to create duplicate
            const res = await fetch(API_ADMIN, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ACCESS_TOKEN}`,
                    'x-app-type': 'uta'
                },
                body: JSON.stringify({ name: 'Test Duplicate Market', description: 'Second instance' })
            });

            const data = await res.json();
            log('Duplicate Market Test Result', data);
            alert('Check log for duplicate market test results. System should handle with unique slug.');
        }

        async function testInactiveMarketVisibility() {
            log('EDGE CASE TEST', 'Testing inactive market visibility...');

            // Get public markets
            const publicRes = await fetch(`${API_PUBLIC}/markets`);
            const publicData = await publicRes.json();

            log('Public Markets (should only show active)', publicData);
            alert('Check log. Public endpoint should only show active markets.');
        }

        async function testInvalidCoordinates() {
            if (!ACCESS_TOKEN) {
                alert('Please login first!');
                return;
            }

            log('EDGE CASE TEST', 'Testing invalid coordinates...');

            const res = await fetch(API_ADMIN, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ACCESS_TOKEN}`,
                    'x-app-type': 'uta'
                },
                body: JSON.stringify({
                    name: 'Invalid Coords Test',
                    latitude: 999,  // Invalid
                    longitude: -999  // Invalid
                })
            });

            const data = await res.json();
            log('Invalid Coordinates Test Result', data);
            alert('Check log. Should return validation error for invalid coordinates.');
        }

        async function testEmptyMarketName() {
            if (!ACCESS_TOKEN) {
                alert('Please login first!');
                return;
            }

            log('EDGE CASE TEST', 'Testing empty market name...');

            const res = await fetch(API_ADMIN, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ACCESS_TOKEN}`,
                    'x-app-type': 'uta'
                },
                body: JSON.stringify({ name: '', description: 'No name' })
            });

            const data = await res.json();
            log('Empty Name Test Result', data);
            alert('Check log. Should return validation error for empty name.');
        }

        // ==================== DISPLAY HELPERS ====================

        function displayMarkets(markets, elementId, isAdmin = false) {
            const container = document.getElementById(elementId);

            if (!markets || markets.length === 0) {
                container.innerHTML = '<p><em>No markets found</em></p>';
                return;
            }

            let html = `<h3>Found ${markets.length} market(s)</h3>`;

            markets.forEach(market => {
                const statusBadge = market.status === 'active'
                    ? '<span class="badge badge-active">Active</span>'
                    : '<span class="badge badge-inactive">Inactive</span>';

                const publicBadge = market.is_public
                    ? '<span class="badge badge-public">Public</span>'
                    : '<span class="badge badge-private">Private</span>';

                html += `
                    <div class="market-card">
                        <h4>${market.name} ${statusBadge} ${publicBadge}</h4>
                        <p><strong>ID:</strong> <code>${market.id}</code></p>
                        <p><strong>Slug:</strong> ${market.slug}</p>
                        <p><strong>Description:</strong> ${market.description || '<em>No description</em>'}</p>
                        <p><strong>Location:</strong> ${market.city}, ${market.state}, ${market.country}</p>
                        ${market.latitude && market.longitude ? `<p><strong>Coordinates:</strong> ${market.latitude}, ${market.longitude}</p>` : ''}
                        ${isAdmin ? `<p><strong>Created:</strong> ${new Date(market.created_at).toLocaleString()}</p>` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }
    </script>
</body>

</html>