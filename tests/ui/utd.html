<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTD - Rider Flow</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; border-top: 5px solid #28a745; }
        .step { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .hidden { display: none; }
        code { background: #eee; padding: 2px 5px; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üõµ UTD (Rider) Flow</h1>
    <p>Scope: <code>utd</code> (Public Registration -> Profile Completion)</p>

    <!-- STEP 1 -->
    <div id="step1" class="step">
        <h3>Step 1: Register / Login</h3>
        <input type="email" id="email" placeholder="Enter your email" value="rider@unitoko.com" style="width: 100%; padding: 8px;">
        <br><br>
        <button onclick="sendOtp()">Send OTP</button>
        <button onclick="showPasswordLogin()" style="margin-left: 10px; background: #17a2b8; color: white; border: none; cursor: pointer;">Login with Password</button>
        <button onclick="showResetFlow()" style="margin-left: 10px; background: #f8f9fa; border: 1px solid #ddd; cursor: pointer;">Forgot Password?</button>
    </div>

    <!-- PASSWORD LOGIN -->
    <div id="stepPasswordLogin" class="step hidden" style="border-color: #17a2b8;">
        <h3>üîë Login with Email & Password</h3>
        <input type="email" id="loginEmail" placeholder="Email" style="width: 100%; padding: 8px; margin-bottom: 5px;">
        <input type="password" id="loginPassword" placeholder="Password" style="width: 100%; padding: 8px; margin-bottom: 5px;">
        <br><br>
        <button onclick="loginWithPassword()">Login</button>
        <button onclick="hidePasswordLogin()" style="margin-left: 10px;">Cancel</button>
    </div>

    <!-- RESET PASSWORD FLOW -->
    <div id="stepReset" class="step hidden" style="border-color: #ffc107;">
        <h3>üîë Reset Password</h3>
        <div id="resetRequest">
            <input type="email" id="resetEmail" placeholder="Enter email" style="width: 100%; margin-bottom: 5px;">
            <button onclick="sendResetOtp()">Send Reset OTP</button>
            <button onclick="hideResetFlow()">Cancel</button>
        </div>
        <div id="resetVerify" class="hidden">
            <input type="text" id="resetOtp" placeholder="OTP Code" style="width: 100%; margin-bottom: 5px;">
            <input type="password" id="resetNewPass" placeholder="New Password" style="width: 100%; margin-bottom: 5px;">
            <input type="password" id="resetConfirmPass" placeholder="Confirm Password" style="width: 100%; margin-bottom: 5px;">
            <button onclick="submitResetPassword()">Set New Password</button>
        </div>
    </div>

    <!-- STEP 2 -->
    <div id="step2" class="step hidden">
        <h3>Step 2: Verify OTP</h3>
        <input type="text" id="otp" placeholder="Enter OTP" style="width: 100%; padding: 8px;">
        <br><br>
        <button onclick="verifyOtp()">Login</button>
    </div>

    <!-- STEP 3 -->
    <div id="step3" class="step hidden">
        <h3>Step 3: Complete Profile</h3>
        <h3>Step 3: Complete Profile</h3>
        <div style="background: #e2e3e5; padding: 10px; margin-bottom: 10px;">
            ‚ö†Ô∏è Profile Incomplete. Please finish setup.
        </div>
        
        <!-- AVATAR UPLOAD -->
        <div style="margin-bottom: 10px; text-align: center;">
            <img id="avatarPreviewInit" src="" style="width: 80px; height: 80px; border-radius: 50%; background: #ddd; object-fit: cover;">
            <br>
            <input type="file" id="avatarInputInit" onchange="uploadAvatar('Init')">
            <input type="hidden" id="avatarUrlInit">
        </div>

        <input type="text" id="name" placeholder="Full Name" style="width: 100%; padding: 8px; margin-bottom: 5px;">
        <input type="text" id="phone" placeholder="Phone" style="width: 100%; padding: 8px; margin-bottom: 5px;">
        <br><br>
        <button onclick="updateProfile()">Save Profile</button>
    </div>

    <!-- STEP 4 -->
    <div id="step4" class="step hidden">
        <h3>üéâ Dashboard</h3>
        <p>Welcome, <span id="username">User</span>!</p>
        <p>Token: <code id="tokenDisplay">...</code></p>
        
        <hr>
        <h4>üîê Security Settings</h4>
        <h4>üîê Security Settings</h4>
        
        <!-- PROFILE EDITOR -->
        <div style="margin-bottom: 15px; padding: 10px; background: #fff; border: 1px solid #ddd;">
            <h5>üë§ Edit Profile</h5>
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <img id="currentAvatar" src="" style="width: 60px; height: 60px; border-radius: 50%; background: #eee; margin-right: 10px; object-fit: cover;">
                <div>
                   <input type="file" id="avatarInputDash" onchange="uploadAvatar('Dash')">
                </div>
            </div>
            <input type="text" id="dashName" placeholder="Name" style="width: 100%; margin-bottom: 5px;">
            <input type="text" id="dashPhone" placeholder="Phone" style="width: 100%; margin-bottom: 5px;">
            <button onclick="saveDashboardProfile()">Update Profile</button>
        </div>

        <!-- SET PASSWORD -->
        <div style="margin-bottom: 15px; padding: 10px; background: #f1f3f5;">
            <h5>Set Password (First Time)</h5>
            <input type="password" id="setPassVal" placeholder="New Password">
            <button onclick="setPassword()">Set Password</button>
        </div>

        <!-- CHANGE PASSWORD -->
        <div style="margin-bottom: 15px; padding: 10px; background: #f1f3f5;">
            <h5>Change Password</h5>
            <input type="password" id="oldPass" placeholder="Old Password" style="margin-bottom: 5px;"><br>
            <input type="password" id="newPass" placeholder="New Password" style="margin-bottom: 5px;">
            <input type="password" id="confirmPass" placeholder="Confirm New" style="margin-bottom: 5px;"><br>
            <button onclick="changePassword()">Change Password</button>
        </div>
    </div>

    <h3>Debug Log</h3>
    <pre id="log">Logs will appear here...</pre>

    <script>
        const API = 'http://localhost:4000/api/auth';
        const SCOPE = 'utd';
        let ACCESS_TOKEN = null;

        function log(msg) {
            document.getElementById('log').textContent = JSON.stringify(msg, null, 2);
        }

        async function sendOtp() {
            const email = document.getElementById('email').value;
            try {
                const res = await fetch(`${API}/otp/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-app-type': SCOPE },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                log(data);
                if (res.ok) {
                    document.getElementById('step1').classList.add('hidden');
                    document.getElementById('step2').classList.remove('hidden');
                }
            } catch (err) { log(err); }
        }

        async function verifyOtp() {
            const email = document.getElementById('email').value;
            const otp = document.getElementById('otp').value;
            try {
                const res = await fetch(`${API}/otp/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-app-type': SCOPE },
                    body: JSON.stringify({ email, otp })
                });
                const data = await res.json();
                log(data);
                
                if (res.ok) {
                    ACCESS_TOKEN = data.accessToken;
                    document.getElementById('step2').classList.add('hidden');
                    
                    if (!data.is_profile_complete) {
                        document.getElementById('step3').classList.remove('hidden');
                    } else {
                        showDashboard(data.user);
                    }
                }
            } catch (err) { log(err); }
        }

        async function updateProfile() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const avatar_url = document.getElementById('avatarUrlInit').value;

            try {
                const res = await fetch(`${API}/profile`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'x-app-type': SCOPE
                    },
                    body: JSON.stringify({ name, phone, avatar_url })
                });
                const data = await res.json();
                log(data);
                if (res.ok) {
                    document.getElementById('step3').classList.add('hidden');
                    showDashboard(data.user);
                }
            } catch (err) { log(err); }
        }

        function showDashboard(user) {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('stepPasswordLogin').classList.add('hidden');
            document.getElementById('stepReset').classList.add('hidden');
            document.getElementById('step4').classList.remove('hidden');
            document.getElementById('username').textContent = user.name || user.email;
            document.getElementById('tokenDisplay').textContent = ACCESS_TOKEN.substring(0, 20) + '...';
            
            // Populate Dashboard Fields
            document.getElementById('dashName').value = user.name || '';
            document.getElementById('dashPhone').value = user.phone || '';
            if (user.avatar_url) {
                document.getElementById('currentAvatar').src = user.avatar_url;
            }
        }

        // --- PASSWORD LOGIN ---
        function showPasswordLogin() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('stepPasswordLogin').classList.remove('hidden');
        }

        function hidePasswordLogin() {
            document.getElementById('stepPasswordLogin').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }

        async function loginWithPassword() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const res = await fetch(`${API}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-app-type': SCOPE },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                log(data);
                if (res.ok) {
                    ACCESS_TOKEN = data.accessToken;
                    if (!data.is_profile_complete) {
                        document.getElementById('stepPasswordLogin').classList.add('hidden');
                        document.getElementById('step3').classList.remove('hidden');
                    } else {
                        showDashboard(data.user);
                    }
                }
            } catch (err) { log(err); }
        }

        // --- PASSWORD FUNCTIONS ---

        function showResetFlow() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('stepReset').classList.remove('hidden');
        }
        function hideResetFlow() {
            document.getElementById('stepReset').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }

        async function sendResetOtp() {
            const email = document.getElementById('resetEmail').value;
            try {
                const res = await fetch(`${API}/password/forgot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-app-type': SCOPE },
                    body: JSON.stringify({ email })
                });
                log(await res.json());
                if (res.ok) {
                    document.getElementById('resetRequest').classList.add('hidden');
                    document.getElementById('resetVerify').classList.remove('hidden');
                }
            } catch (err) { log(err); }
        }

        async function submitResetPassword() {
            const email = document.getElementById('resetEmail').value;
            const otp = document.getElementById('resetOtp').value;
            const newPassword = document.getElementById('resetNewPass').value;
            const confirmPassword = document.getElementById('resetConfirmPass').value;
            
            try {
                const res = await fetch(`${API}/password/reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-app-type': SCOPE },
                    body: JSON.stringify({ email, otp, newPassword, confirmPassword })
                });
                const data = await res.json();
                log(data);
                if (res.ok) {
                    alert('Password Reset Successful! Use it to login.');
                    location.reload();
                }
            } catch (err) { log(err); }
        }

        async function setPassword() {
            const password = document.getElementById('setPassVal').value;
            try {
                const res = await fetch(`${API}/password/set`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'x-app-type': SCOPE
                    },
                    body: JSON.stringify({ password })
                });
                log(await res.json());
            } catch (err) { log(err); }
        }

        async function changePassword() {
            const oldPassword = document.getElementById('oldPass').value;
            const newPassword = document.getElementById('newPass').value;
            const confirmPassword = document.getElementById('confirmPass').value;
            
            try {
                const res = await fetch(`${API}/password/change`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'x-app-type': SCOPE
                    },
                    body: JSON.stringify({ oldPassword, newPassword, confirmPassword })
                });
                log(await res.json());
            } catch (err) { log(err); }
        }

        async function uploadAvatar(suffix) {
            const input = document.getElementById(`avatarInput${suffix}`);
            if (!input.files[0]) return;

            const formData = new FormData();
            formData.append('avatar', input.files[0]);

            try {
                const res = await fetch(`${API}/media/upload/avatar`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'x-app-type': SCOPE
                    },
                    body: formData
                });
                const data = await res.json();
                log(data);

                if (res.ok) {
                    if (suffix === 'Init') {
                         document.getElementById('avatarUrlInit').value = data.url;
                         document.getElementById('avatarPreviewInit').src = data.url;
                    } else {
                        // For dashboard, maybe auto-save or just show preview? 
                        // Let's just show preview and require clicking "Update Profile"
                        document.getElementById('currentAvatar').src = data.url;
                        // Store it temporarily or update immediately? 
                        // Let's update immediately for better UX or store in a hidden field?
                        // Actually, let's just save it.
                         saveDashboardProfile(data.url);
                    }
                }
            } catch (err) { log(err); }
        }

        async function saveDashboardProfile(newAvatarUrl = null) {
            const name = document.getElementById('dashName').value;
            const phone = document.getElementById('dashPhone').value;
            // If newAvatarUrl is passed, use it, otherwise keep existing (not easily accessible unless stored)
            // Ideally we fetch current user again or store current state.
            // Simplified: We rely on the input values.
            
            // Hack for demo: If we just uploaded an avatar, we passed the URL. 
            // If not, we don't send avatar_url to avoid overwriting with null?
            // Our backend completeProfile merges? No, it updates.
            
            const payload = { name, phone };
            if (newAvatarUrl) payload.avatar_url = newAvatarUrl;

            try {
                const res = await fetch(`${API}/profile`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ACCESS_TOKEN}`, 'x-app-type': SCOPE },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                log(data);
                if (res.ok) {
                    alert('Profile Updated!');
                    document.getElementById('username').textContent = data.user.name;
                    if(data.user.avatar_url) document.getElementById('currentAvatar').src = data.user.avatar_url;
                }
            } catch (err) { log(err); }
        }
    </script>
</body>
</html>
